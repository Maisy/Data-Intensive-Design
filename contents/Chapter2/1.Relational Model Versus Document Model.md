## 관계형 모델 vs 문서모델

관계형 모델은 **트랜젝션 처리**나 **일괄처리**(batch)와 같은 비즈니스 데이터 처리를 하기 위해 출현하였다.

(일괄처리는 실시간 처리와 비교하면 RDB는 쓰기 성능이 그렇게 좋진 않으니까. 배치처리에 RDB가 더 적합한 느낌)

- 관계형 모델: 데이터가 관계(relation)와 순서가 없는 튜플(tuple)로 구성된다.
  - SQL에서 관계는 table, 튜플은 row다

관계형 데이터 모델의 목표는 정리된 인터페이스 뒤로 세부 사항을 숨기는 것이다.

네트워크 모델과 계층 모델, 객체 데이터베이스, XML 데이터베이스들이 경쟁자로 나왔지만 얼마가지 않았다.

- 네트워크 모델: 부모 레코드와 자식 레코드가 N:M관계인 일반화된 그래프 구조이다.
- 계층 모델: 부모 레코드와 자식 레코드가 1:N 관계인 트리형태이다.

### NoSQL의 탄생

"Not Only SQL".

- (관계형 데이터베이스보다) 더 빠르게 쓰고싶다, 대규모 데이터셋을 다루고 싶다
  - RDB는 쓰기가 좋지않아
- 무료 오픈소스 소프트웨어였으면 좋겠다.
- 관계형 모델에서 지원하지않는 특수 질의 동작
- 관계형 스키마의 제한에 대한 불만과 더욱 동적이고 표현력이 풍부한 데이터 모델에 대한 바람

애플리케이션에따라 데이터를 처리하는 방법이 각기 다르다. 따라서 이제는 관계형 데이터베이스 뿐만 아니라 다양한 비관계형 데이터스토어를 함꼐 사용하게 될것이다. (polyglot persistence. 다중 저장소 지속성)

- 배치 처리와 실시간 처리(스트림 처리) 계층으로 이루어진 **람다 아키텍처**에서 배치 처리 결과는 관계형 데이터베이스에 저장하고 실시간 처리 결과는 비관계형 데이터베이스에 저장한다
    - 실시간 처리 결과를 저장하기 위해서는 매우 높은 쓰기 처리량이 필요하며 관계형 데이터베이스는 이에 적합하지 않다
    - 애플리케이션에서 실시간 데이터와 배치데이터를 병합하여 조회한다.(배치에 있으면 그대로 배치데이터를 보고, 없으면 실시간데이터를 가져온다)
    - 실시간은 ES에 저장하고 배치를 RDB(hadoop)에 저장하고..
    - 스케줄 관리는 airflow
- 광고주 정보는 RDB로 관리하지만 view와 비슷하게 cassandra에서 키워드에 대한 노출가능한 광고를 관리하고있다가 해당 키워드가 들어오면 바로 해당 광고를 노출한다. (동기화 관리는 동기화 서버가 따로 하고 있다)

### 객체 관계형 불일치(The Object-Relational Mismatch)

데이터를 관계형 테이블에 저장하려면 애플리케이션 코드를 무.족.권. 데이터베이스 모델객체(table, row, column)로 전환해줘야한다.
ActiveRecoard나 Hibernate 같은 객체 관계형 매핑(ORM) 프레임워크가 코드의 양을 줄여주긴 하지만 모델간의 차이(impedance mismatch)가 있을수 밖에 없다.


이력서 정보에서 한 user에 여러 contact정보(github, blog, twitter..)와 같은 일대다(one-to-many) 관계를 표현하는 방법을 알아보자.
관계형에서는

1. 각 테이블에 넣고 외래키로 참조하거나
2. JSON이나 XML문서로 부호화해 텍스트 칼럼에 (통으로) 저장하는 방법이 있다. 이 방식은 칼럼의 값을 질의하는데 사용할 수 없다.
3. 또 다른 방법은 SQL의 마지막 버전 XML, JSON 데이터를 지원하는 data type을 사용하는거다.

- XML 지원: 오라클, IBM DB2, 마이크로소프트 SQL서버, PostgreSQL
- JSON 지원: IBM DB2, MySQL, PostgreSQL

JSON 데이터를 지원하는 문서지향(document-oriented) 데이터베이스의 종류는 아래와 같다.

- MongoDB
- RethinkDB
- CouchDB
- Espresso

관계형 모델에서 데이터를 가져오려면 질의를 여러번해서 application에서 합치거나, join을 계속 해야하는 반면 JSON에서는 한방에 가져올수 있다.(locality 굿)

### 다대일과 다대다 관계

도시이름과 같이 UI에서 드롭다운 형태로 제공되는 아이들은 raw text가 아닌 ID로 저장하는게 좋다. 왜냐면

- 일관된 텍스트로 제공 가능
- 모호함 회피(이름이 같은 여러 도시가 있는 경우)
- 이름을 변경해야하는 경우 갱신이 편리함
- 현지화 지원(번역)
- 검색의 편리함 (역삼을 검색할지 강남구로 검색할지 명확하게 알수있다)
  
(따라서 ID에는 의미있는값이 들어가면 변경해야할 수 있기 때문에 권장하지 않는다)

중복된 데이터를 정규화 하려면 다대일(many-to-one), 다대다(many-to-many) 관계가 필요한데 문서모델에서는 join에 대한 지원이 약하다. 따라서 **애플리케이션 코드에서 join을 흉내내야한다.**
(RethinkDB는 join을 지원, MongoDB는 지원안함, CouchDB는 미리 선언된 뷰에서만 지원, ES에는 nested라는 타입이 있긴 한데 느려서 안쓴다고)

> nosql에서는 ODM(Object Document Mapping)을 사용해서 join을 사용할수 있다.
> e.g.) (Mongoose)[https://www.zerocho.com/category/MongoDB/post/5963b908cebb5e001834680e]


### 문서 데이터베이스는 역사를 반복하고 있나?

1970년대 가장 많이 사용한 데이터베이스는 IBM의 정보관리시스템(IMS)인데, NoSQL과 유사한 계층모델이다. 하지만 다대다 관계 표현이라는 한계가 있었고, 이를 위한 해결책이 네트워크 모델과 관계형 모델이다.

#### 네트워크 모델 (= CODASYL. 코다실 모델)

- N:1과 N:M 관계를 모델링할 수 있다.
- 데이터 접근 방법은 root recoard에서 연속적으로 연결된 경로를 따라가는거다. (접근경로)
- 질의와 갱신이 복잡하고 유연하지 못하다.

#### 관계형 모델

- 접근경로가 단순하다. 접근경로를 애플리케이션 개발자가 아니라 질의 최적화기(query optimizer)가 자동으로 만들어준다! (새로운 Index를 선언하기만 하면 자동으로 가장 적합한 index를 사용한다.)
   
#### 문서 데이터베이스와의 비교

- 다대일과 다대다 관계를 표현할때 관계형 모델에서는 외래키, 문서 모델에서는 문서참조(document reference)[https://docs.mongodb.com/manual/reference/database-references/#document-references]라 부른다.

### 관계형 데이터베이스 vs 오늘날의 문서 데이터베이스

#### Schema

- 문서 데이터베이스는 스키마리스(schemaless)로 불리지만 정확하게 말하면 읽기 스키마(schema-on-read: 데이터 구조는 암묵적이고 데이터를 읽을 때 해석하며 구조의 유형을 어느정도 가정함)다. 데이터베이스가 스키마를 강요하지않는다.
- 관계형 데이터베이스는 쓰기 스키마(schema-on-write: 쓰여진 모든 데이터가 스키마를 따르고 있음을 보장). 정적타입.

#### 스키마를 변경할때는?

- 문서 데이터베이스는 애플리케이션에서 새로운 문서 / 예전 문서를 읽은 경우를 처리하는 코드를 작성한다.
- 관계형 데이터베이스에서는 마이그레이션(migration)을 수행한다.
  - 대부분의 관계형 데이터베이스의 ALTER TABLE은 수 밀리초안에 수행됨. (MySQL은 ALTER TABLE시 전체 테이블을 복사해서 수분~수시간 중단시간 발생)
  - 큰 데이터에 UPDATE문을 실행하면 오래걸림. 새로운 칼럼이 추가된 경우 디폴트인 NULL로 넣어두고 문서 데이터베이스처럼 읽을 때 채워준다.

#### 질의를 위한 데이터 지역성

문서 **전체**에 자주 접근해야 할 때(storage loacality), 한번에 문서의 많은 부분을 필요로 하는 경우에 좋다.
문서를 갱신할 때도 전체 문서를 재작성해야하기 때문에 _문서를 아주 작게 유지하는게 좋다._

관계형 모델에서도 locality를 위해 그룹화 하는 개념이 있다

- 구글의 Spanner: 부모테이블 내에 중첩되게 테이블의 로우를 교차배치함
- 오라클: 다중 테이블 색인 클러스터 테이블(multi-table index cluster table)
- 카산드라, HBase: Bigtable 데이터 모델의 column-family
    - column-family는 하나의 테이블이라고 보면돼(스키마). 그래서 DB 서버가 10대가 있다고 하면 같은 column family끼리는 물리적으로 가까운 서버(예를 들면 4대)에 먼저 데이터를 저장한다.


관계형 데이터베이스와 문서 데이터베이스는 서로 부족한 부분을 보완해나가며 비슷해지고 있다.
위에 언급된 내용과 같이 관계형 데이터베이스에서는 XML, JSON 형식을 지원하고 있다. 문서 데이터베이스에서 RethinkDB는 질의 언어에서 관계형 조인을 지원하고 MongoDB 드라이버는 자동으로 데이터베이스 참조를 확인한다.(실제로 클라이언트쪽 조인을 수행한다. 네트워크 왕복이 필요하고 최적화가 덜 되기 때문에 데이터베이스에서 수행되는 조인보다 느릴 수 있다.)